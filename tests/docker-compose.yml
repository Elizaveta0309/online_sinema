version: '3'

services:
  api-test:
    container_name: api-test
    build:
      dockerfile: tests/api/Dockerfile
      context: ../
    ports:
      - "8000:8000"

  tests:
    container_name: tests
    build: .

  postgres-test:
    image: postgres
    container_name: postgres-test
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"

  elasticsearch-test:
    container_name: elasticsearch-test
    image: docker.elastic.co/elasticsearch/elasticsearch:8.6.0
    ports:
      - "9200:9200"
    environment:
      - xpack.security.enabled=false
      - discovery.type=single-node

  redis-test:
    container_name: redis-test
    image: redis
    ports:
      - "6379:6379"

  nginx-test:
    build:
      dockerfile: nginx/Dockerfile
      context: .
    container_name: nginx-test
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/configs:/etc/nginx/conf.d:ro
    ports:
      - "80:80"

  etl-test:
    container_name: etl-test
    build:
      dockerfile: etl/Dockerfile
      context: .
    env_file:
      - api/.env
    volumes:
      - ./etl:/etl
    restart: on-failure
